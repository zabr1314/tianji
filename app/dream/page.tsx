'use client'

import { useState } from 'react'
import Image from 'next/image'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Label } from '@/components/ui/label'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Textarea } from '@/components/ui/textarea'
import { Moon, Sparkles, RefreshCw, Brain, Heart, Star, TrendingUp, AlertCircle, Lightbulb, Download, Share2, Copy, Check } from 'lucide-react'
import { DreamCategory, DreamMood } from '@/lib/dream/calculator'
import { LightweightMarkdown } from '@/components/ui/lightweight-markdown'

interface DreamInterpretationResult {
  success: boolean
  dream_input: {
    content: string
    category: string
    mood: string
    dreamer_info?: any
  }
  analysis: {
    dream_summary: string
    category_analysis: {
      primary_category: string
      secondary_categories: string[]
      symbolic_elements: string[]
    }
    psychological_analysis: {
      subconscious_themes: string[]
      emotional_state: string
      potential_triggers: string[]
      stress_indicators: string[]
    }
    symbolic_interpretation: {
      key_symbols: Array<{
        symbol: string
        traditional_meaning: string
        psychological_meaning: string
        personal_relevance: string
      }>
    }
    life_guidance: {
      current_situation_insights: string[]
      emotional_needs: string[]
      growth_opportunities: string[]
      recommended_actions: string[]
    }
    dream_quality: {
      clarity_score: number
      emotional_intensity: number
      symbolic_richness: number
      overall_significance: number
    }
    warnings_and_suggestions: {
      health_reminders: string[]
      relationship_insights: string[]
      career_guidance: string[]
      spiritual_messages: string[]
    }
  }
  ai_interpretation: string
  cost: number
  error?: string
}

export default function DreamInterpretationPage() {
  const [formData, setFormData] = useState({
    dream_content: '',
    dream_category: '' as DreamCategory,
    dream_mood: '' as DreamMood,
    dream_frequency: 'occasional' as 'rare' | 'occasional' | 'frequent',
    lucid_dream: false,
    dreamer_info: {
      age_range: '' as '18-25' | '26-35' | '36-45' | '46-55' | '55+' | '',
      gender: '' as 'male' | 'female' | '',
      life_stage: '' as 'student' | 'working' | 'married' | 'retired' | '',
      recent_stress: false
    }
  })

  const [result, setResult] = useState<DreamInterpretationResult | null>(null)
  const [isAnalyzing, setIsAnalyzing] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [isSaving, setIsSaving] = useState(false)
  const [isSharing, setIsSharing] = useState(false)
  const [copied, setCopied] = useState(false)
  const [shareImageUrl, setShareImageUrl] = useState<string | null>(null)
  const [showShareImage, setShowShareImage] = useState(false)

  const validateForm = (): boolean => {
    const { dream_content, dream_category, dream_mood } = formData
    if (!dream_content) {
      setError('ËØ∑ËæìÂÖ•Ê¢¶Â¢ÉÂÜÖÂÆπÊèèËø∞')
      return false
    }
    if (dream_content.length < 10) {
      setError('Ê¢¶Â¢ÉÊèèËø∞Ëøá‰∫éÁÆÄÁü≠ÔºåËØ∑ËØ¶ÁªÜÊèèËø∞ÊÇ®ÁöÑÊ¢¶Â¢É')
      return false
    }
    if (!dream_category) {
      setError('ËØ∑ÈÄâÊã©Ê¢¶Â¢É‰∏ªË¶ÅÂàÜÁ±ª')
      return false
    }
    if (!dream_mood) {
      setError('ËØ∑ÈÄâÊã©Ê¢¶Â¢É‰∏≠ÁöÑÊÉÖÁª™')
      return false
    }
    return true
  }

  const handleAnalyze = async () => {
    if (!validateForm()) return

    setIsAnalyzing(true)
    setError(null)
    setResult(null)

    try {
      const requestData = {
        ...formData,
        dreamer_info: {
          ...formData.dreamer_info,
          age_range: formData.dreamer_info.age_range || undefined,
          gender: formData.dreamer_info.gender || undefined,
          life_stage: formData.dreamer_info.life_stage || undefined
        }
      }

      const response = await fetch('/api/dream/interpret', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || 'Ê¢¶Â¢ÉËß£ÊûêÂ§±Ë¥•')
      }

      setResult(data)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï')
    } finally {
      setIsAnalyzing(false)
    }
  }

  const handleReset = () => {
    setResult(null)
    setError(null)
    setShareImageUrl(null)
    setShowShareImage(false)
  }

  // ‰øùÂ≠òÊä•ÂëäÂäüËÉΩ
  const handleSaveReport = async () => {
    if (!result) return
    
    setIsSaving(true)
    try {
      // ÁîüÊàêPDFÊä•ÂëäÂÜÖÂÆπ
      const reportContent = generateDreamReportContent(result)
      
      // ÂàõÂª∫Âπ∂‰∏ãËΩΩÊñá‰ª∂
      const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `Ê¢¶Â¢ÉËß£ÊûêÊä•Âëä_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.txt`
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      URL.revokeObjectURL(url)
    } catch (error) {
      console.error('‰øùÂ≠òÊä•ÂëäÂ§±Ë¥•:', error)
      alert('‰øùÂ≠òÊä•ÂëäÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï')
    } finally {
      setIsSaving(false)
    }
  }

  // ÂàÜ‰∫´Ê¢¶Â¢ÉËß£ÊûêÁªìÊûú
  const handleShareResult = async () => {
    if (!result) return
    
    setIsSharing(true)
    try {
      // ÁîüÊàêÂàÜ‰∫´ÂõæÁâá
      const shareImageBlob = await generateDreamShareImage(result)
      
      if (shareImageBlob) {
        // ÂàõÂª∫ÂõæÁâáURLÁî®‰∫éÈ°µÈù¢ÊòæÁ§∫
        const imageUrl = URL.createObjectURL(shareImageBlob)
        setShareImageUrl(imageUrl)
        setShowShareImage(true)
      } else {
        // ÈôçÁ∫ßÊñπÊ°àÔºöÊñáÊú¨ÂàÜ‰∫´
        const shareText = `üåô ÊàëÂú®Â§©Êú∫AIÂÆåÊàê‰∫ÜÊ¢¶Â¢ÉËß£ÊûêÔºÅ
‚ú® Ê¢¶Â¢ÉÂàÜÁ±ªÔºö${result.dream_input.category}
üí≠ ÊÉÖÁª™Áä∂ÊÄÅÔºö${result.dream_input.mood}
üîÆ AI‰∏∫ÊàëÊè≠Á§∫‰∫ÜÊ∑±Â±ÇÁöÑÂøÉÁêÜÁä∂ÊÄÅÂíå‰∫∫ÁîüÊåáÂºï
üåü Êù•‰ΩìÈ™å‰∏ì‰∏öÁöÑÊ¢¶Â¢ÉËß£ÊûêÂêßÔºÅ
#Â§©Êú∫AI #Ê¢¶Â¢ÉËß£Êûê #AIËß£Ê¢¶`
        
        if (navigator.share) {
          await navigator.share({
            title: 'ÊàëÁöÑÊ¢¶Â¢ÉËß£ÊûêÊä•Âëä',
            text: shareText,
            url: window.location.href
          })
        } else {
          await navigator.clipboard.writeText(shareText)
          setCopied(true)
          setTimeout(() => setCopied(false), 2000)
        }
      }
    } catch (error) {
      console.error('ÂàÜ‰∫´Â§±Ë¥•:', error)
      try {
        const shareText = `Â§©Êú∫AI - Ê¢¶Â¢ÉËß£ÊûêÊä•Âëä\n\nÊ¢¶Â¢ÉÂàÜÁ±ªÔºö${result.dream_input.category}\nÊÉÖÁª™Áä∂ÊÄÅÔºö${result.dream_input.mood}\n\nÊü•ÁúãËØ¶ÊÉÖÔºö${window.location.href}`
        await navigator.clipboard.writeText(shareText)
        setCopied(true)
        setTimeout(() => setCopied(false), 2000)
      } catch (clipboardError) {
        alert('ÂàÜ‰∫´Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï')
      }
    } finally {
      setIsSharing(false)
    }
  }

  // ÂÖ≥Èó≠ÂàÜ‰∫´ÂõæÁâáÊòæÁ§∫
  const handleCloseShareImage = () => {
    setShowShareImage(false)
    if (shareImageUrl) {
      URL.revokeObjectURL(shareImageUrl)
      setShareImageUrl(null)
    }
  }

  // ‰∏ãËΩΩÂàÜ‰∫´ÂõæÁâá
  const handleDownloadShareImage = () => {
    if (!shareImageUrl) return
    
    const a = document.createElement('a')
    a.href = shareImageUrl
    a.download = `Ê¢¶Â¢ÉËß£ÊûêÂàÜ‰∫´_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.png`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
  }

  const getQualityColor = (score: number) => {
    if (score >= 8) return 'text-green-600'
    if (score >= 6) return 'text-blue-600'
    if (score >= 4) return 'text-yellow-600'
    return 'text-red-600'
  }

  const getQualityLabel = (score: number) => {
    if (score >= 8) return 'ÂæàÈ´ò'
    if (score >= 6) return 'ËæÉÈ´ò'
    if (score >= 4) return '‰∏≠Á≠â'
    return '‰∏ÄËà¨'
  }

  // ÁîüÊàêÊ¢¶Â¢ÉËß£ÊûêÊä•ÂëäÂÜÖÂÆπ
  const generateDreamReportContent = (data: DreamInterpretationResult): string => {
    const date = new Date().toLocaleDateString('zh-CN')
    return `
==============================
          Ê¢¶Â¢ÉËß£ÊûêÊä•Âëä
==============================

ÁîüÊàêÊó∂Èó¥Ôºö${date}
Ê¢¶Â¢ÉÂàÜÁ±ªÔºö${data.dream_input.category}
ÊÉÖÁª™Áä∂ÊÄÅÔºö${data.dream_input.mood}

==============================
           Ê¢¶Â¢ÉÊëòË¶Å
==============================
${data.analysis.dream_summary}

==============================
          Ê¢¶Â¢ÉË¥®ÈáèËØÑ‰º∞
==============================
Ê∏ÖÊô∞Â∫¶Ôºö${data.analysis.dream_quality.clarity_score}/10 (${getQualityLabel(data.analysis.dream_quality.clarity_score)})
ÊÉÖÊÑüÂº∫Â∫¶Ôºö${data.analysis.dream_quality.emotional_intensity}/10 (${getQualityLabel(data.analysis.dream_quality.emotional_intensity)})
Ë±°ÂæÅ‰∏∞ÂØåÂ∫¶Ôºö${data.analysis.dream_quality.symbolic_richness}/10 (${getQualityLabel(data.analysis.dream_quality.symbolic_richness)})
Êï¥‰ΩìÈáçË¶ÅÊÄßÔºö${data.analysis.dream_quality.overall_significance}/10 (${getQualityLabel(data.analysis.dream_quality.overall_significance)})

==============================
           ÂøÉÁêÜÁä∂ÊÄÅÂàÜÊûê
==============================
ÊÉÖÁª™Áä∂ÊÄÅÔºö${data.analysis.psychological_analysis.emotional_state}

ÊΩúÊÑèËØÜ‰∏ªÈ¢òÔºö
${data.analysis.psychological_analysis.subconscious_themes.map(theme => `‚Ä¢ ${theme}`).join('\n')}

ÂéãÂäõÊåáÊ†áÔºö
${data.analysis.psychological_analysis.stress_indicators.map(indicator => `‚Ä¢ ${indicator}`).join('\n')}

==============================
           Ë±°ÂæÅËß£ËØª
==============================
${data.analysis.symbolic_interpretation.key_symbols.map(symbol => `
„Äê${symbol.symbol}„Äë
‰º†ÁªüÂê´‰πâÔºö${symbol.traditional_meaning}
ÂøÉÁêÜÂ≠¶Âê´‰πâÔºö${symbol.psychological_meaning}
‰∏™‰∫∫Áõ∏ÂÖ≥ÊÄßÔºö${symbol.personal_relevance}
`).join('\n')}

==============================
           ÁîüÊ¥ªÊåáÂØº
==============================
ÂΩìÂâçÁä∂ÂÜµÊ¥ûÂØüÔºö
${data.analysis.life_guidance.current_situation_insights.map(insight => `‚Ä¢ ${insight}`).join('\n')}

ÊÉÖÊÑüÈúÄÊ±ÇÔºö
${data.analysis.life_guidance.emotional_needs.map(need => `‚Ä¢ ${need}`).join('\n')}

ÊàêÈïøÊú∫‰ºöÔºö
${data.analysis.life_guidance.growth_opportunities.map(opportunity => `‚Ä¢ ${opportunity}`).join('\n')}

Âª∫ËÆÆË°åÂä®Ôºö
${data.analysis.life_guidance.recommended_actions.map(action => `‚Ä¢ ${action}`).join('\n')}

==============================
           Ë≠¶Á§∫‰∏éÂª∫ËÆÆ
==============================
ÂÅ•Â∫∑ÊèêÈÜíÔºö
${data.analysis.warnings_and_suggestions.health_reminders.map(reminder => `‚Ä¢ ${reminder}`).join('\n')}

Á≤æÁ•ûÂêØÁ§∫Ôºö
${data.analysis.warnings_and_suggestions.spiritual_messages.map(message => `‚Ä¢ ${message}`).join('\n')}

==============================
          AIÊ∑±Â∫¶Ëß£ËØª
==============================
${data.ai_interpretation}

==============================
Êú¨Ê¨°ÂàÜÊûêÊ∂àËÄóÔºö${data.cost} Â§©Êú∫ÁÇπ
Êä•ÂëäÁî±Â§©Êú∫AIÁîüÊàê - ‰ªÖ‰æõÂèÇËÄÉ
==============================`
  }

  // ÁîüÊàêÂàÜ‰∫´ÂõæÁâá
  const generateDreamShareImage = async (data: DreamInterpretationResult): Promise<Blob | null> => {
    try {
      // Âä®ÊÄÅÂØºÂÖ•html2canvas
      const html2canvas = await import('html2canvas').then(module => module.default)
      
      // ÂàõÂª∫ÂàÜ‰∫´ÂÜÖÂÆπÂÖÉÁ¥†
      const shareElement = document.createElement('div')
      shareElement.style.cssText = `
        width: 450px;
        height: 800px;
        background: linear-gradient(135deg, #fef7ed 0%, #fed7aa 50%, #fdba74 100%);
        font-family: serif;
        position: fixed;
        top: -9999px;
        left: -9999px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      `
      
      // ÊèêÂèñÂÖ≥ÈîÆËß£ÊûêÂÜÖÂÆπ
      const keyInsights = extractDreamKeyContent(data)
      
      shareElement.innerHTML = `
        <div style="padding: 32px 24px; height: 100%; display: flex; flex-direction: column; color: #8b4513;">
          <!-- Ê†áÈ¢òÂå∫Âüü -->
          <div style="text-align: center; margin-bottom: 24px;">
            <div style="background: #dc2626; color: white; display: inline-block; padding: 12px 20px; border-radius: 8px; font-size: 20px; font-weight: bold; margin-bottom: 8px;">
              ÊàëÁöÑÊ¢¶Â¢ÉËß£ÊûêÊä•Âëä
            </div>
            <div style="font-size: 14px; color: #a16207;">Â§©Êú∫AI ¬∑ ‰∏™ÊÄßËß£ËØª</div>
          </div>
          
          <!-- Ê¢¶Â¢ÉÁâπÂæÅ -->
          <div style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 2px solid #f59e0b;">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
              <span style="font-size: 16px;">üåô</span>
              <span style="font-weight: bold; margin-left: 8px; font-size: 14px;">Ê¢¶Â¢ÉÁâπÂæÅ</span>
            </div>
            <div style="font-size: 12px; line-height: 1.6;">
              <div style="margin-bottom: 4px;"><strong>ÂàÜÁ±ªÔºö</strong>${data.dream_input.category}</div>
              <div style="margin-bottom: 4px;"><strong>ÊÉÖÁª™Ôºö</strong>${data.dream_input.mood}</div>
              <div><strong>Êï¥‰ΩìÈáçË¶ÅÊÄßÔºö</strong>${data.analysis.dream_quality.overall_significance}/10</div>
            </div>
          </div>
          
          <!-- ÂøÉÁêÜËß£ËØª -->
          <div style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 2px solid #f59e0b;">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
              <span style="font-size: 16px;">üß†</span>
              <span style="font-weight: bold; margin-left: 8px; font-size: 14px;">ÂøÉÁêÜËß£ËØª</span>
            </div>
            <div style="font-size: 11px; line-height: 1.5; color: #7c2d12;">
              ${keyInsights.psychology}
            </div>
          </div>
          
          <!-- ÁîüÊ¥ªÊåáÂØº -->
          <div style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 2px solid #f59e0b; flex: 1;">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
              <span style="font-size: 16px;">‚ú®</span>
              <span style="font-weight: bold; margin-left: 8px; font-size: 14px;">ÁîüÊ¥ªÊåáÂØº</span>
            </div>
            <div style="font-size: 11px; line-height: 1.5; color: #7c2d12;">
              ${keyInsights.guidance}
            </div>
          </div>
          
          <!-- Â∫ïÈÉ®Ë£ÖÈ•∞ -->
          <div style="text-align: center; padding-top: 16px; border-top: 2px solid #f59e0b;">
            <div style="font-size: 12px; color: #a16207; font-weight: bold;">Êâ´Á†Å‰ΩìÈ™å‰∏ì‰∏öÁöÑAIÊ¢¶Â¢ÉËß£Êûê</div>
          </div>
        </div>
      `
      
      document.body.appendChild(shareElement)
      
      // ‰ΩøÁî®html2canvasÁîüÊàêÂõæÁâá
      const canvas = await html2canvas(shareElement, {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#fef7ed',
        width: 450,
        height: 800,
        scrollX: 0,
        scrollY: 0,
        windowWidth: 450,
        windowHeight: 800
      })
      
      document.body.removeChild(shareElement)
      
      // ËΩ¨Êç¢‰∏∫Blob
      return new Promise((resolve) => {
        canvas.toBlob(resolve, 'image/png')
      })
    } catch (error) {
      console.error('ÁîüÊàêÂàÜ‰∫´ÂõæÁâáÂ§±Ë¥•:', error)
      return null
    }
  }

  // ÊèêÂèñÊ¢¶Â¢ÉÂÖ≥ÈîÆËß£ÊûêÂÜÖÂÆπ
  const extractDreamKeyContent = (data: DreamInterpretationResult) => {
    // ÊèêÂèñÂøÉÁêÜËß£ËØªÂÖ≥ÈîÆÂÜÖÂÆπ
    const psychology = data.analysis.psychological_analysis.emotional_state.length > 60 
      ? data.analysis.psychological_analysis.emotional_state.substring(0, 60) + '...' 
      : data.analysis.psychological_analysis.emotional_state
    
    // ÊèêÂèñÁîüÊ¥ªÊåáÂØºÂÖ≥ÈîÆÂÜÖÂÆπ
    const topGuidance = data.analysis.life_guidance.current_situation_insights.slice(0, 2)
    const guidance = topGuidance.length > 0 
      ? topGuidance.join('Ôºõ').length > 80 
        ? topGuidance.join('Ôºõ').substring(0, 80) + '...'
        : topGuidance.join('Ôºõ')
      : 'ÊöÇÊó†ÊåáÂØºÂÜÖÂÆπ'
    
    return {
      psychology,
      guidance
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-red-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
      
      <div className="relative z-10">
      <main className="container mx-auto px-4 py-8">
        <div className="max-w-6xl mx-auto">

          {!result && !isAnalyzing && (
            <>
              {/* È°µÈù¢Ê†áÈ¢ò - ÁÆÄÊ¥ÅËÆæËÆ° */}
              <section className="text-center mb-12">
                <div className="max-w-4xl mx-auto">
                  <h1 className="text-5xl font-serif font-bold text-red-700 dark:text-red-400 mb-6">
                    Ê¢¶Â¢ÉËß£Êûê
                  </h1>
                  
                  <p className="text-xl font-serif text-amber-700 dark:text-amber-300 mb-8">
                    ËøêÁî®AIÊô∫ÊÖßÔºåËß£ËØªÊ¢¶Â¢ÉÂ••ÁßòÔºåÊ¥ûÂØüÂÜÖÂøÉ‰∏ñÁïå
                  </p>
                  
                  {/* ÂäüËÉΩÁâπËâ≤ - ÁÆÄÂåñÁâà */}
                  <div className="flex justify-center items-center space-x-12 text-amber-600 dark:text-amber-400">
                    <div className="flex items-center space-x-2">
                      <Moon className="h-5 w-5" />
                      <span className="font-serif">Ê¢¶Â¢ÉÂàÜÊûê</span>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Brain className="h-5 w-5" />
                      <span className="font-serif">ÂøÉÁêÜËß£ËØª</span>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Sparkles className="h-5 w-5" />
                      <span className="font-serif">AIÊô∫ÊÖß</span>
                    </div>
                  </div>
                </div>
              </section>

              {/* ËæìÂÖ•Ë°®Âçï - ÂÆã‰ª£ÁæéÂ≠¶È£éÊ†º */}
              <section className="mb-16">
                <Card className="max-w-4xl mx-auto shadow-2xl border-2 border-amber-300 dark:border-amber-600 bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 dark:from-slate-800 dark:via-slate-700 dark:to-slate-800 backdrop-blur-sm">
                  <CardHeader className="text-center relative">
                    {/* ‰º†Áªü‰∫ëÁ∫πË£ÖÈ•∞ */}
                    <div className="absolute top-4 left-4 w-8 h-8 opacity-20">
                      <svg viewBox="0 0 32 32" className="w-full h-full text-amber-400">
                        <path d="M8,16 Q4,8 8,4 Q12,0 16,4 Q20,0 24,4 Q28,8 24,16 Q28,24 24,28 Q20,32 16,28 Q12,32 8,28 Q4,24 8,16 Z" fill="currentColor"/>
                      </svg>
                    </div>
                    <div className="absolute top-4 right-4 w-8 h-8 opacity-20">
                      <svg viewBox="0 0 32 32" className="w-full h-full text-amber-400">
                        <path d="M8,16 Q4,8 8,4 Q12,0 16,4 Q20,0 24,4 Q28,8 24,16 Q28,24 24,28 Q20,32 16,28 Q12,32 8,28 Q4,24 8,16 Z" fill="currentColor"/>
                      </svg>
                    </div>
                    
                    <CardTitle className="text-3xl font-serif font-bold text-amber-800 dark:text-amber-200 mb-4">
                      Ê¢¶Â¢ÉÂΩïÂÖ•
                    </CardTitle>
                    
                    {/* Âè§ÂÖ∏Ë£ÖÈ•∞Á∫ø */}
                    <div className="flex items-center justify-center mb-4">
                      <div className="w-16 h-px bg-amber-400 dark:bg-amber-600"></div>
                      <div className="mx-3 w-2 h-2 bg-amber-400 dark:bg-amber-600 rounded-full"></div>
                      <div className="w-16 h-px bg-amber-400 dark:bg-amber-600"></div>
                    </div>
                    
                    <CardDescription className="text-lg font-serif text-amber-700 dark:text-amber-300 leading-relaxed">
                      ËØ∑ËØ¶Ëø∞Ê¢¶Â¢ÉÂÜÖÂÆπÔºåÈÄâÊã©ÂàÜÁ±ªÊÉÖÁª™Ôºå‰ª•Âä©AIÊ∑±Â∫¶Ëß£Êûê
                    </CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-6">
                    {/* Ê¢¶Â¢ÉÊèèËø∞ */}
                    <div>
                      <Label htmlFor="dream-content">Ê¢¶Â¢ÉÂÜÖÂÆπ *</Label>
                      <Textarea
                        id="dream-content"
                        placeholder="ËØ∑ËØ¶ÁªÜÊèèËø∞ÊÇ®ÁöÑÊ¢¶Â¢ÉÔºåÂåÖÊã¨Ê¢¶‰∏≠ÁöÑ‰∫∫Áâ©„ÄÅÂú∫ÊôØ„ÄÅÊÉÖËäÇ„ÄÅÊÑüÂèóÁ≠â..."
                        value={formData.dream_content}
                        onChange={(e) => setFormData({...formData, dream_content: e.target.value})}
                        rows={6}
                        maxLength={2000}
                      />
                      <div className="flex justify-between text-xs text-muted-foreground mt-1">
                        <span>ËØ∑ËØ¶ÁªÜÊèèËø∞ÔºåÊúâÂä©‰∫éÊõ¥ÂáÜÁ°ÆÁöÑËß£Êûê</span>
                        <span>{formData.dream_content.length}/2000</span>
                      </div>
                    </div>

                    {/* Ê¢¶Â¢ÉÂàÜÁ±ªÂíåÊÉÖÁª™ */}
                    <div className="grid md:grid-cols-2 gap-6">
                      <div className="space-y-4">
                        <h3 className="font-semibold">Ê¢¶Â¢ÉÁâπÂæÅ</h3>
                        
                        <div>
                          <Label htmlFor="dream-category">Ê¢¶Â¢ÉÂàÜÁ±ª *</Label>
                          <Select value={formData.dream_category} onValueChange={(value: DreamCategory) => setFormData({...formData, dream_category: value})}>
                            <SelectTrigger>
                              <SelectValue placeholder="ÈÄâÊã©Ê¢¶Â¢É‰∏ªË¶ÅÂàÜÁ±ª" />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value={DreamCategory.PEOPLE}>‰∫∫Áâ©</SelectItem>
                              <SelectItem value={DreamCategory.ANIMALS}>Âä®Áâ©</SelectItem>
                              <SelectItem value={DreamCategory.OBJECTS}>Áâ©ÂìÅ</SelectItem>
                              <SelectItem value={DreamCategory.NATURE}>Ëá™ÁÑ∂</SelectItem>
                              <SelectItem value={DreamCategory.EMOTIONS}>ÊÉÖÊÑü</SelectItem>
                              <SelectItem value={DreamCategory.ACTIONS}>Ë°å‰∏∫</SelectItem>
                              <SelectItem value={DreamCategory.PLACES}>Âú∫ÊâÄ</SelectItem>
                              <SelectItem value={DreamCategory.SUPERNATURAL}>Ë∂ÖËá™ÁÑ∂</SelectItem>
                              <SelectItem value={DreamCategory.WORK_STUDY}>Â∑•‰ΩúÂ≠¶‰π†</SelectItem>
                              <SelectItem value={DreamCategory.OTHER}>ÂÖ∂‰ªñ</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>

                        <div>
                          <Label htmlFor="dream-mood">Ê¢¶Â¢ÉÊÉÖÁª™ *</Label>
                          <Select value={formData.dream_mood} onValueChange={(value: DreamMood) => setFormData({...formData, dream_mood: value})}>
                            <SelectTrigger>
                              <SelectValue placeholder="ÈÄâÊã©Ê¢¶Â¢É‰∏≠ÁöÑ‰∏ªË¶ÅÊÉÖÁª™" />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value={DreamMood.HAPPY}>ÊÑâÂø´</SelectItem>
                              <SelectItem value={DreamMood.ANXIOUS}>ÁÑ¶Ëôë</SelectItem>
                              <SelectItem value={DreamMood.FEARFUL}>ÊÅêÊÉß</SelectItem>
                              <SelectItem value={DreamMood.CONFUSED}>Âõ∞ÊÉë</SelectItem>
                              <SelectItem value={DreamMood.PEACEFUL}>Âπ≥Èùô</SelectItem>
                              <SelectItem value={DreamMood.EXCITED}>ÂÖ¥Â•ã</SelectItem>
                              <SelectItem value={DreamMood.SAD}>ÊÇ≤‰º§</SelectItem>
                              <SelectItem value={DreamMood.ANGRY}>ÊÑ§ÊÄí</SelectItem>
                              <SelectItem value={DreamMood.NEUTRAL}>‰∏≠ÊÄß</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>

                        <div>
                          <Label htmlFor="dream-frequency">ÂÅöÊ¢¶È¢ëÁéá</Label>
                          <Select value={formData.dream_frequency} onValueChange={(value: 'rare' | 'occasional' | 'frequent') => setFormData({...formData, dream_frequency: value})}>
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="rare">ÂæàÂ∞ëÂÅöÊ¢¶</SelectItem>
                              <SelectItem value="occasional">ÂÅ∂Â∞îÂÅöÊ¢¶</SelectItem>
                              <SelectItem value="frequent">ÁªèÂ∏∏ÂÅöÊ¢¶</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>

                        <div className="flex items-center space-x-2">
                          <input
                            type="checkbox"
                            id="lucid-dream"
                            checked={formData.lucid_dream}
                            onChange={(e) => setFormData({...formData, lucid_dream: e.target.checked})}
                            className="rounded"
                          />
                          <Label htmlFor="lucid-dream" className="text-sm">ËøôÊòØÊ∏ÖÈÜíÊ¢¶ÔºàÁü•ÈÅìËá™Â∑±Âú®ÂÅöÊ¢¶Ôºâ</Label>
                        </div>
                      </div>

                      <div className="space-y-4">
                        <h3 className="font-semibold">‰∏™‰∫∫‰ø°ÊÅØÔºàÂèØÈÄâÔºâ</h3>
                        <p className="text-sm text-muted-foreground">
                          Êèê‰æõ‰∏™‰∫∫‰ø°ÊÅØÊúâÂä©‰∫éÊõ¥ÂáÜÁ°ÆÁöÑËß£Ê¢¶ÂàÜÊûê
                        </p>
                        
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <Label htmlFor="age-range">Âπ¥ÈæÑÊÆµ</Label>
                            <Select value={formData.dreamer_info.age_range} onValueChange={(value: '18-25' | '26-35' | '36-45' | '46-55' | '55+') => setFormData({...formData, dreamer_info: {...formData.dreamer_info, age_range: value}})}>
                              <SelectTrigger>
                                <SelectValue placeholder="ÈÄâÊã©Âπ¥ÈæÑÊÆµ" />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem value="18-25">18-25Â≤Å</SelectItem>
                                <SelectItem value="26-35">26-35Â≤Å</SelectItem>
                                <SelectItem value="36-45">36-45Â≤Å</SelectItem>
                                <SelectItem value="46-55">46-55Â≤Å</SelectItem>
                                <SelectItem value="55+">55Â≤Å‰ª•‰∏ä</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>
                          
                          <div>
                            <Label htmlFor="gender">ÊÄßÂà´</Label>
                            <Select value={formData.dreamer_info.gender} onValueChange={(value: 'male' | 'female') => setFormData({...formData, dreamer_info: {...formData.dreamer_info, gender: value}})}>
                              <SelectTrigger>
                                <SelectValue placeholder="ÈÄâÊã©ÊÄßÂà´" />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem value="male">Áî∑</SelectItem>
                                <SelectItem value="female">Â•≥</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>
                        </div>

                        <div>
                          <Label htmlFor="life-stage">‰∫∫ÁîüÈò∂ÊÆµ</Label>
                          <Select value={formData.dreamer_info.life_stage} onValueChange={(value: 'student' | 'working' | 'married' | 'retired') => setFormData({...formData, dreamer_info: {...formData.dreamer_info, life_stage: value}})}>
                            <SelectTrigger>
                              <SelectValue placeholder="ÈÄâÊã©‰∫∫ÁîüÈò∂ÊÆµ" />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="student">Â≠¶ÁîüÊó∂Êúü</SelectItem>
                              <SelectItem value="working">Â∑•‰ΩúÊúüÈó¥</SelectItem>
                              <SelectItem value="married">Â∑≤Â©öÂÆ∂Â∫≠</SelectItem>
                              <SelectItem value="retired">ÈÄÄ‰ºëÈò∂ÊÆµ</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>

                        <div className="flex items-center space-x-2">
                          <input
                            type="checkbox"
                            id="recent-stress"
                            checked={formData.dreamer_info.recent_stress}
                            onChange={(e) => setFormData({...formData, dreamer_info: {...formData.dreamer_info, recent_stress: e.target.checked}})}
                            className="rounded"
                          />
                          <Label htmlFor="recent-stress" className="text-sm">ÊúÄËøëÁîüÊ¥ªÂéãÂäõËæÉÂ§ß</Label>
                        </div>
                      </div>
                    </div>

                    {/* ÂàÜÊûêÊåâÈíÆ - Âè§ÂÖ∏È£éÊ†º */}
                    <div className="text-center pt-6">
                      <div className="relative inline-block">
                        {/* ÊåâÈíÆË£ÖÈ•∞ËæπÊ°Ü */}
                        <div className="absolute -inset-2 bg-gradient-to-r from-amber-400 via-orange-400 to-red-400 rounded-lg opacity-20 blur-sm"></div>
                        <Button 
                          onClick={handleAnalyze}
                          size="lg"
                          className="relative bg-gradient-to-r from-amber-600 via-orange-600 to-red-600 hover:from-amber-700 hover:via-orange-700 hover:to-red-700 text-white font-serif px-16 py-4 text-lg shadow-xl border-2 border-amber-300 dark:border-amber-500"
                          disabled={isAnalyzing}
                        >
                          {isAnalyzing ? (
                            <>
                              <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div>
                              <span className="font-serif tracking-wide">Ëß£ÊûêÊ¢¶Â¢É‰∏≠...</span>
                            </>
                          ) : (
                            <>
                              <Moon className="w-5 h-5 mr-3" />
                              <span className="font-serif tracking-wide">ÂºÄÂßãËß£Ê¢¶</span>
                            </>
                          )}
                        </Button>
                      </div>
                      
                      {/* Ë¥πÁî®ËØ¥Êòé - Âè§ÂÖ∏Ê†∑Âºè */}
                      <div className="mt-4 text-center">
                        <div className="inline-flex items-center px-4 py-2 bg-amber-100 dark:bg-amber-800 rounded-full border border-amber-300 dark:border-amber-600">
                          <div className="w-2 h-2 bg-amber-500 rounded-full mr-2"></div>
                          <span className="text-sm font-serif text-amber-700 dark:text-amber-300">
                            Ê∂àËÄó 80 Â§©Êú∫ÁÇπ
                          </span>
                          <div className="w-2 h-2 bg-amber-500 rounded-full ml-2"></div>
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </section>
            </>
          )}

          {/* ÂàÜÊûê‰∏≠Áä∂ÊÄÅ */}
          {isAnalyzing && (
            <section className="text-center py-16">
              <Card className="max-w-2xl mx-auto border border-purple-200 dark:border-purple-700 bg-white/90 dark:bg-slate-900/90">
                <CardContent className="pt-12 pb-12">
                  <div className="flex flex-col items-center space-y-6">
                    <div className="relative">
                      <div className="animate-spin rounded-full h-16 w-16 border-4 border-purple-600 border-t-transparent"></div>
                      <Moon className="absolute inset-0 m-auto h-6 w-6 text-purple-600" />
                    </div>
                    <div className="text-center">
                      <h3 className="text-xl font-serif font-semibold mb-2 text-slate-700 dark:text-slate-300">Ê≠£Âú®Ëß£ÊûêÊ¢¶Â¢É...</h3>
                      <p className="text-base font-serif text-slate-600 dark:text-slate-400 mb-4">
                        AIÊ≠£Âú®ÁªìÂêàÂøÉÁêÜÂ≠¶ÁêÜËÆ∫Âíå‰º†ÁªüËß£Ê¢¶Êô∫ÊÖßÔºåÊ∑±Â∫¶ÂàÜÊûêÊÇ®ÁöÑÊ¢¶Â¢É
                      </p>
                      <div className="flex flex-wrap justify-center gap-2">
                        <Badge variant="secondary" className="bg-purple-100 dark:bg-purple-800 text-purple-700 dark:text-purple-300 font-serif">Ê¢¶Â¢ÉÂàÜÁ±ª</Badge>
                        <Badge variant="secondary" className="bg-purple-100 dark:bg-purple-800 text-purple-700 dark:text-purple-300 font-serif">ÂøÉÁêÜÂàÜÊûê</Badge>
                        <Badge variant="secondary" className="bg-purple-100 dark:bg-purple-800 text-purple-700 dark:text-purple-300 font-serif">Ë±°ÂæÅËß£ËØª</Badge>
                        <Badge variant="secondary" className="bg-purple-100 dark:bg-purple-800 text-purple-700 dark:text-purple-300 font-serif">ÁîüÊ¥ªÊåáÂØº</Badge>
                        <Badge variant="secondary" className="bg-purple-100 dark:bg-purple-800 text-purple-700 dark:text-purple-300 font-serif">AIÊ∑±Â∫¶Ëß£Èáä</Badge>
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {/* ÈîôËØØÊòæÁ§∫ */}
          {error && (
            <section className="text-center py-8">
              <Card className="max-w-2xl mx-auto border-red-200">
                <CardContent className="pt-6">
                  <div className="text-center text-red-600 mb-4">
                    <p className="text-lg font-semibold">{error}</p>
                  </div>
                  <Button onClick={() => setError(null)} variant="outline">
                    <RefreshCw className="h-4 w-4 mr-2" />
                    ÈáçÊñ∞Ëß£Êûê
                  </Button>
                </CardContent>
              </Card>
            </section>
          )}

          {/* Ëß£ÊûêÁªìÊûú */}
          {result && (
            <section>
              <div className="text-center mb-8">
                <h3 className="text-3xl font-serif font-bold text-purple-700 dark:text-purple-300 mb-4">Ê¢¶Â¢ÉËß£ÊûêÁªìÊûú</h3>
                <div className="w-24 h-px bg-purple-300 dark:bg-purple-600 mx-auto mb-6"></div>
                <Button onClick={handleReset} variant="outline" className="font-serif border-purple-300 dark:border-purple-600">
                  <RefreshCw className="h-4 w-4 mr-2" />
                  Ëß£ÊûêÂÖ∂‰ªñÊ¢¶Â¢É
                </Button>
              </div>

              {/* Ê¢¶Â¢ÉÊëòË¶Å - ÂÆã‰ª£ÁæéÂ≠¶È£éÊ†º */}
              <Card className="mb-12 shadow-2xl border-2 border-amber-300 dark:border-amber-600 bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 dark:from-slate-800 dark:via-slate-700 dark:to-slate-800">
                <CardHeader className="text-center relative pb-8">
                  {/* ËÉåÊôØË£ÖÈ•∞ */}
                  <div className="absolute inset-0 opacity-5">
                    <svg className="w-full h-full" viewBox="0 0 400 200">
                      <circle cx="100" cy="50" r="30" fill="currentColor" className="text-amber-400"/>
                      <circle cx="300" cy="150" r="20" fill="currentColor" className="text-orange-400"/>
                      <path d="M50,100 Q100,80 150,100 T250,100" stroke="currentColor" strokeWidth="2" fill="none" className="text-red-400"/>
                    </svg>
                  </div>
                  
                  {/* ÂàÜÁ±ªÊ†áÁ≠æ */}
                  <div className="relative z-10 mb-6">
                    <div className="inline-flex items-center px-4 py-2 bg-amber-100 dark:bg-amber-800 rounded-full border border-amber-300 dark:border-amber-600">
                      <span className="text-sm font-serif text-amber-700 dark:text-amber-300">
                        {result.dream_input.category} ‚Ä¢ {result.dream_input.mood}ÊÉÖÁª™
                      </span>
                    </div>
                  </div>
                  
                  {/* Ë£ÖÈ•∞Á∫ø */}
                  <div className="flex items-center justify-center mb-6">
                    <div className="w-16 h-px bg-amber-400 dark:bg-amber-600"></div>
                    <div className="mx-4 w-3 h-3 border-2 border-amber-400 dark:border-amber-600 rounded-full bg-amber-100 dark:bg-amber-800"></div>
                    <div className="w-16 h-px bg-amber-400 dark:bg-amber-600"></div>
                  </div>
                  
                  {/* ‰º†ÁªüÂç∞Á´†ÂºèÊ†áÈ¢ò */}
                  <div className="relative inline-block mb-6">
                    <div className="absolute inset-0 bg-red-600 dark:bg-red-700 transform rotate-45 rounded-lg opacity-15"></div>
                    <CardTitle className="relative text-4xl font-serif font-bold text-red-700 dark:text-red-400 px-8 py-4 tracking-wider">
                      Ê¢¶Â¢ÉËß£ÊûêÊä•Âëä
                    </CardTitle>
                  </div>
                  
                  {/* ÊëòË¶ÅÂÜÖÂÆπ */}
                  <div className="bg-white/80 dark:bg-slate-900/80 rounded-lg p-6 border border-amber-200 dark:border-amber-700 shadow-lg max-w-4xl mx-auto">
                    <p className="text-lg font-serif leading-relaxed text-slate-700 dark:text-slate-300 text-justify">
                      {result.analysis.dream_summary}
                    </p>
                  </div>
                </CardHeader>
              </Card>

              {/* Ê¢¶Â¢ÉË¥®ÈáèËØÑ‰º∞ */}
              <div className="grid md:grid-cols-4 gap-4 mb-8">
                {Object.entries(result.analysis.dream_quality).map(([key, score]) => {
                  const labels = {
                    clarity_score: 'Ê∏ÖÊô∞Â∫¶',
                    emotional_intensity: 'ÊÉÖÊÑüÂº∫Â∫¶',
                    symbolic_richness: 'Ë±°ÂæÅ‰∏∞ÂØåÂ∫¶',
                    overall_significance: 'Êï¥‰ΩìÈáçË¶ÅÊÄß'
                  }
                  
                  return (
                    <Card key={key} className="border border-purple-200 dark:border-purple-700 bg-white/90 dark:bg-slate-900/90">
                      <CardHeader className="text-center pb-2">
                        <CardTitle className="text-sm font-serif font-semibold text-purple-700 dark:text-purple-300">
                          {labels[key as keyof typeof labels]}
                        </CardTitle>
                      </CardHeader>
                      <CardContent className="text-center">
                        <div className={`text-2xl font-serif font-bold ${getQualityColor(score)} drop-shadow-sm`}>
                          {score}/10
                        </div>
                        <div className="text-xs font-serif text-purple-600 dark:text-purple-400">
                          {getQualityLabel(score)}
                        </div>
                      </CardContent>
                    </Card>
                  )
                })}
              </div>

              {/* ÂàÜÁ±ªÂíåË±°ÂæÅÂàÜÊûê */}
              <div className="grid md:grid-cols-2 gap-6 mb-8">
                <Card className="border border-purple-200 dark:border-purple-700 bg-white/90 dark:bg-slate-900/90">
                  <CardHeader className="text-center">
                    <CardTitle className="text-lg font-serif font-bold text-purple-700 dark:text-purple-300">Ê¢¶Â¢ÉÂàÜÊûê</CardTitle>
                    <div className="w-12 h-px bg-purple-300 dark:bg-purple-600 mx-auto mt-2"></div>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div>
                      <div className="font-semibold text-sm mb-2">‰∏ªË¶ÅÂàÜÁ±ª</div>
                      <Badge variant="outline" className="mb-2">
                        {result.analysis.category_analysis.primary_category}
                      </Badge>
                    </div>
                    
                    {result.analysis.category_analysis.secondary_categories.length > 0 && (
                      <div>
                        <div className="font-semibold text-sm mb-2">Ê¨°Ë¶ÅÂàÜÁ±ª</div>
                        <div className="flex flex-wrap gap-2">
                          {result.analysis.category_analysis.secondary_categories.map((category, index) => (
                            <Badge key={index} variant="secondary">{category}</Badge>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {result.analysis.category_analysis.symbolic_elements.length > 0 && (
                      <div>
                        <div className="font-semibold text-sm mb-2">Ë±°ÂæÅÂÖÉÁ¥†</div>
                        <div className="flex flex-wrap gap-2">
                          {result.analysis.category_analysis.symbolic_elements.map((element, index) => (
                            <Badge key={index} variant="outline">{element}</Badge>
                          ))}
                        </div>
                      </div>
                    )}
                  </CardContent>
                </Card>

                <Card className="border border-purple-200 dark:border-purple-700 bg-white/90 dark:bg-slate-900/90">
                  <CardHeader className="text-center">
                    <CardTitle className="text-lg font-serif font-bold text-purple-700 dark:text-purple-300">ÂøÉÁêÜÁä∂ÊÄÅ</CardTitle>
                    <div className="w-12 h-px bg-purple-300 dark:bg-purple-600 mx-auto mt-2"></div>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div>
                      <div className="font-semibold text-sm mb-2">ÊÉÖÁª™Áä∂ÊÄÅ</div>
                      <p className="text-sm text-muted-foreground">
                        {result.analysis.psychological_analysis.emotional_state}
                      </p>
                    </div>
                    
                    {result.analysis.psychological_analysis.subconscious_themes.length > 0 && (
                      <div>
                        <div className="font-semibold text-sm mb-2">ÊΩúÊÑèËØÜ‰∏ªÈ¢ò</div>
                        <div className="flex flex-wrap gap-2">
                          {result.analysis.psychological_analysis.subconscious_themes.map((theme, index) => (
                            <Badge key={index} variant="secondary">{theme}</Badge>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {result.analysis.psychological_analysis.stress_indicators.length > 0 && (
                      <div>
                        <div className="font-semibold text-sm mb-2">ÂéãÂäõÊåáÊ†á</div>
                        <ul className="space-y-1">
                          {result.analysis.psychological_analysis.stress_indicators.map((indicator, index) => (
                            <li key={index} className="flex items-center text-sm">
                              <AlertCircle className="w-3 h-3 text-orange-500 mr-2" />
                              {indicator}
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </CardContent>
                </Card>
              </div>

              {/* Ë±°ÂæÅËß£Èáä */}
              {result.analysis.symbolic_interpretation.key_symbols.length > 0 && (
                <Card className="mb-8 border border-purple-200 dark:border-purple-700 bg-white/90 dark:bg-slate-900/90">
                  <CardHeader className="text-center">
                    <CardTitle className="text-xl font-serif font-bold text-purple-700 dark:text-purple-300">Ë±°ÂæÅÁ¨¶Âè∑Ëß£ËØª</CardTitle>
                    <div className="w-16 h-px bg-purple-300 dark:bg-purple-600 mx-auto mt-2"></div>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-4">
                      {result.analysis.symbolic_interpretation.key_symbols.map((symbol, index) => (
                        <div key={index} className="border rounded-lg p-4">
                          <div className="font-semibold text-lg mb-2 flex items-center">
                            <Star className="w-4 h-4 mr-2 text-yellow-500" />
                            {symbol.symbol}
                          </div>
                          <div className="grid md:grid-cols-3 gap-4 text-sm">
                            <div>
                              <div className="font-medium text-blue-600 mb-1">‰º†ÁªüÂê´‰πâ</div>
                              <p className="text-muted-foreground">{symbol.traditional_meaning}</p>
                            </div>
                            <div>
                              <div className="font-medium text-purple-600 mb-1">ÂøÉÁêÜÂ≠¶Âê´‰πâ</div>
                              <p className="text-muted-foreground">{symbol.psychological_meaning}</p>
                            </div>
                            <div>
                              <div className="font-medium text-green-600 mb-1">‰∏™‰∫∫Áõ∏ÂÖ≥ÊÄß</div>
                              <p className="text-muted-foreground">{symbol.personal_relevance}</p>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </CardContent>
                </Card>
              )}

              {/* ÁîüÊ¥ªÊåáÂØº */}
              <div className="grid md:grid-cols-2 gap-6 mb-8">
                <Card>
                  <CardHeader>
                    <CardTitle className="text-teal-600">ÁîüÊ¥ªÊ¥ûÂØü</CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    {result.analysis.life_guidance.current_situation_insights.length > 0 && (
                      <div>
                        <div className="font-semibold text-sm mb-2">ÂΩìÂâçÁä∂ÂÜµ</div>
                        <ul className="space-y-1">
                          {result.analysis.life_guidance.current_situation_insights.map((insight, index) => (
                            <li key={index} className="flex items-center text-sm">
                              <div className="w-2 h-2 bg-teal-500 rounded-full mr-3"></div>
                              {insight}
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}
                    
                    {result.analysis.life_guidance.emotional_needs.length > 0 && (
                      <div>
                        <div className="font-semibold text-sm mb-2">ÊÉÖÊÑüÈúÄÊ±Ç</div>
                        <ul className="space-y-1">
                          {result.analysis.life_guidance.emotional_needs.map((need, index) => (
                            <li key={index} className="flex items-center text-sm">
                              <Heart className="w-3 h-3 text-pink-500 mr-2" />
                              {need}
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader>
                    <CardTitle className="text-orange-600">ÊàêÈïøÂª∫ËÆÆ</CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    {result.analysis.life_guidance.growth_opportunities.length > 0 && (
                      <div>
                        <div className="font-semibold text-sm mb-2">ÊàêÈïøÊú∫‰ºö</div>
                        <ul className="space-y-1">
                          {result.analysis.life_guidance.growth_opportunities.map((opportunity, index) => (
                            <li key={index} className="flex items-center text-sm">
                              <TrendingUp className="w-3 h-3 text-green-500 mr-2" />
                              {opportunity}
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}
                    
                    {result.analysis.life_guidance.recommended_actions.length > 0 && (
                      <div>
                        <div className="font-semibold text-sm mb-2">Âª∫ËÆÆË°åÂä®</div>
                        <ul className="space-y-1">
                          {result.analysis.life_guidance.recommended_actions.map((action, index) => (
                            <li key={index} className="flex items-center text-sm">
                              <Lightbulb className="w-3 h-3 text-yellow-500 mr-2" />
                              {action}
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </CardContent>
                </Card>
              </div>

              {/* Ë≠¶Á§∫ÂíåÂª∫ËÆÆ */}
              <div className="grid md:grid-cols-2 gap-6 mb-8">
                <Card>
                  <CardHeader>
                    <CardTitle className="text-red-600">ÂÅ•Â∫∑ÊèêÈÜí</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <ul className="space-y-2">
                      {result.analysis.warnings_and_suggestions.health_reminders.map((reminder, index) => (
                        <li key={index} className="flex items-center text-sm">
                          <AlertCircle className="w-3 h-3 text-red-500 mr-2" />
                          {reminder}
                        </li>
                      ))}
                    </ul>
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader>
                    <CardTitle className="text-blue-600">Á≤æÁ•ûÂêØÁ§∫</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <ul className="space-y-2">
                      {result.analysis.warnings_and_suggestions.spiritual_messages.map((message, index) => (
                        <li key={index} className="flex items-center text-sm">
                          <Star className="w-3 h-3 text-blue-500 mr-2" />
                          {message}
                        </li>
                      ))}
                    </ul>
                  </CardContent>
                </Card>
              </div>

              {/* AIÊ∑±Â∫¶Ëß£ËØª - ÂÆã‰ª£ÁæéÂ≠¶È£éÊ†ºÔºåÁ™ÅÂá∫ÈáçÁÇπ */}
              <Card className="mb-8 bg-gradient-to-br from-amber-50 via-orange-50 to-red-50 dark:from-slate-800 dark:via-slate-700 dark:to-slate-800 border-2 border-amber-300 dark:border-amber-600 shadow-2xl">
                <CardHeader className="text-center relative">
                  {/* Âè§ÂÖ∏Ë£ÖÈ•∞ */}
                  <div className="absolute top-4 left-1/2 transform -translate-x-1/2 w-16 h-8 opacity-20">
                    <svg viewBox="0 0 64 32" className="w-full h-full text-amber-400">
                      <path d="M8,16 Q16,8 24,16 Q32,8 40,16 Q48,8 56,16 Q48,24 40,16 Q32,24 24,16 Q16,24 8,16 Z" fill="currentColor"/>
                    </svg>
                  </div>
                  
                  {/* ‰º†ÁªüÂç∞Á´†ÂºèÊ†áÈ¢ò */}
                  <div className="relative inline-block mb-6 mt-4">
                    <div className="absolute inset-0 bg-red-600 dark:bg-red-700 transform rotate-45 rounded-lg opacity-15"></div>
                    <CardTitle className="relative text-3xl font-serif font-bold text-red-700 dark:text-red-400 px-6 py-3 tracking-wider">
                      AIÊô∫ÊÖßËß£ËØª
                    </CardTitle>
                  </div>
                  
                  {/* Ë£ÖÈ•∞Á∫ø */}
                  <div className="flex items-center justify-center mb-4">
                    <div className="w-12 h-px bg-amber-400 dark:bg-amber-600"></div>
                    <Sparkles className="h-5 w-5 mx-3 text-amber-500" />
                    <div className="w-12 h-px bg-amber-400 dark:bg-amber-600"></div>
                  </div>
                  
                  <p className="text-lg font-serif text-amber-700 dark:text-amber-300 italic">
                    Ê∑±Â∫¶Ëß£Êûê¬∑Êô∫ÊÖßÂêØËø™¬∑‰∫∫ÁîüÊåáÂºï
                  </p>
                </CardHeader>
                
                <CardContent className="px-8 pb-8">
                  {/* AIËß£ËØªÂÜÖÂÆπ - MarkdownÊ†ºÂºèÊîØÊåÅ */}
                  <div className="bg-white/90 dark:bg-slate-900/90 rounded-lg p-6 border border-amber-200 dark:border-amber-700 shadow-lg">
                    <div className="max-w-none">
                      <LightweightMarkdown
                        content={result.ai_interpretation}
                      />
                      {/* <ReactMarkdown
                        remarkPlugins={[remarkGfm]}
                        components={{
                          // ÊÆµËêΩ - Áªü‰∏ÄÊ†ºÂºè
                          p: ({children}) => (
                            <p className="mb-6 text-base leading-7 text-slate-700 dark:text-slate-300 font-serif" 
                               style={{ textAlign: 'justify', lineHeight: '1.8' }}>
                              {children}
                            </p>
                          ),
                          // Ê†áÈ¢òÁ≥ªÂàó - Ê∏ÖÊô∞Â±ÇÊ¨°
                          h1: ({children}) => (
                            <div className="mb-6 mt-8 first:mt-0">
                              <div className="relative">
                                <div className="absolute inset-0 bg-red-600 dark:bg-red-700 transform rotate-45 rounded-md opacity-10"></div>
                                <h1 className="relative text-2xl font-bold text-red-700 dark:text-red-400 px-4 py-3 font-serif tracking-wide">
                                  {children}
                                </h1>
                              </div>
                            </div>
                          ),
                          h2: ({children}) => (
                            <div className="mb-5 mt-7">
                              <h2 className="text-xl font-semibold text-red-700 dark:text-red-400 border-l-4 border-amber-400 pl-4 py-2 bg-amber-50 dark:bg-amber-900/20 font-serif">
                                {children}
                              </h2>
                            </div>
                          ),
                          h3: ({children}) => (
                            <div className="mb-4 mt-6">
                              <h3 className="text-lg font-medium text-red-600 dark:text-red-400 border-l-3 border-amber-300 pl-3 py-1 font-serif">
                                {children}
                              </h3>
                            </div>
                          ),
                          // Âº∫Ë∞ÉÂíåÊ†ºÂºè
                          strong: ({children}) => (
                            <strong className="text-orange-700 dark:text-orange-300 font-semibold px-1">
                              {children}
                            </strong>
                          ),
                          em: ({children}) => (
                            <em className="text-amber-700 dark:text-amber-300 italic">
                              {children}
                            </em>
                          ),
                          // ÂºïÁî®Âùó - ÈáçË¶Å‰ø°ÊÅØÁ™ÅÂá∫
                          blockquote: ({children}) => (
                            <div className="my-6">
                              <blockquote className="bg-gradient-to-r from-orange-50 via-amber-50 to-yellow-50 dark:from-orange-900/15 dark:via-amber-900/15 dark:to-yellow-900/15 border-l-4 border-orange-400 p-5 rounded-r-lg shadow-sm">
                                <div className="text-orange-800 dark:text-orange-200 font-medium leading-relaxed">
                                  {children}
                                </div>
                              </blockquote>
                            </div>
                          ),
                          // ÊúâÂ∫èÂàóË°® - Ê∏ÖÊô∞ÁºñÂè∑
                          ol: ({children}) => (
                            <div className="my-6">
                              <ol className="space-y-3 counter-reset-none">
                                {children}
                              </ol>
                            </div>
                          ),
                          // Êó†Â∫èÂàóË°®
                          ul: ({children}) => (
                            <div className="my-6">
                              <ul className="space-y-3">
                                {children}
                              </ul>
                            </div>
                          ),
                          // ÂàóË°®È°π - Áªü‰∏ÄÊ†ºÂºè
                          li: ({children, ...props}) => {
                            const isOrdered = (props as any).ordered;
                            return (
                              <li className={`${isOrdered ? 'list-decimal' : 'list-disc'} list-inside text-slate-700 dark:text-slate-300 leading-relaxed pl-2`}>
                                <span className="ml-2 font-serif">{children}</span>
                              </li>
                            )
                          },
                          // ‰ª£Á†Å
                          code: ({children, ...props}) => {
                            const inline = (props as any).inline;
                            if (inline) {
                              return (
                                <code className="bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-200 px-2 py-1 rounded text-sm font-mono">
                                  {children}
                                </code>
                              )
                            }
                            return (
                              <code className="block bg-slate-100 dark:bg-slate-800 p-4 rounded-lg overflow-x-auto text-sm font-mono">
                                {children}
                              </code>
                            )
                          },
                          pre: ({children}) => (
                            <div className="my-6">
                              <pre className="bg-slate-100 dark:bg-slate-800 p-4 rounded-lg overflow-x-auto border border-slate-200 dark:border-slate-700">
                                {children}
                              </pre>
                            </div>
                          ),
                          // ÂàÜÈöîÁ∫ø
                          hr: () => (
                            <div className="my-8">
                              <div className="flex items-center justify-center">
                                <div className="w-16 h-px bg-amber-300 dark:bg-amber-600"></div>
                                <div className="mx-4 w-2 h-2 bg-amber-400 dark:bg-amber-500 rounded-full"></div>
                                <div className="w-16 h-px bg-amber-300 dark:bg-amber-600"></div>
                              </div>
                            </div>
                          )
                        }}
                      >
                        {result.ai_interpretation}
                      </ReactMarkdown> */}
                    </div>
                    
                    {/* Â∫ïÈÉ®Ë£ÖÈ•∞ */}
                    <div className="mt-8 pt-6 border-t border-amber-200 dark:border-amber-700">
                      <div className="flex items-center justify-center text-amber-600 dark:text-amber-400">
                        <div className="w-8 h-px bg-amber-400 dark:bg-amber-600"></div>
                        <div className="mx-3 text-sm font-serif">‚ú¶ Êô∫ÊÖßËß£ËØªÂÆåÊØï ‚ú¶</div>
                        <div className="w-8 h-px bg-amber-400 dark:bg-amber-600"></div>
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Êìç‰ΩúÊåâÈíÆ - Âè§ÂÖ∏È£éÊ†º */}
              <div className="text-center space-y-4">
                <div className="flex flex-wrap justify-center gap-4">
                  <Button 
                    onClick={handleReset} 
                    className="bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white font-serif px-8 py-3 shadow-lg border-2 border-amber-300 dark:border-amber-500"
                  >
                    <Moon className="h-5 w-5 mr-2" />
                    Ëß£ÊûêÂÖ∂‰ªñÊ¢¶Â¢É
                  </Button>
                  <Button 
                    onClick={handleSaveReport}
                    disabled={isSaving}
                    variant="outline" 
                    className="border-2 border-amber-400 dark:border-amber-500 text-amber-700 dark:text-amber-300 hover:bg-amber-50 dark:hover:bg-amber-900/20 font-serif px-8 py-3"
                  >
                    {isSaving ? (
                      <RefreshCw className="h-5 w-5 mr-2 animate-spin" />
                    ) : (
                      <Download className="h-5 w-5 mr-2" />
                    )}
                    {isSaving ? '‰øùÂ≠ò‰∏≠...' : '‰øùÂ≠òÊä•Âëä'}
                  </Button>
                  <Button 
                    onClick={handleShareResult}
                    disabled={isSharing}
                    variant="outline" 
                    className="border-2 border-amber-400 dark:border-amber-500 text-amber-700 dark:text-amber-300 hover:bg-amber-50 dark:hover:bg-amber-900/20 font-serif px-8 py-3"
                  >
                    {copied ? (
                      <Check className="h-5 w-5 mr-2 text-green-500" />
                    ) : isSharing ? (
                      <RefreshCw className="h-5 w-5 mr-2 animate-spin" />
                    ) : (
                      <Share2 className="h-5 w-5 mr-2" />
                    )}
                    {copied ? 'Â∑≤Â§çÂà∂' : isSharing ? 'ÂàÜ‰∫´‰∏≠...' : 'ÂàÜ‰∫´ÁªìÊûú'}
                  </Button>
                </div>

                {/* ÂàÜ‰∫´ÂõæÁâáÊòæÁ§∫Âå∫Âüü */}
                {showShareImage && shareImageUrl && (
                  <div className="mt-8">
                    <Card className="bg-gradient-to-br from-amber-50/90 to-orange-50/90 dark:from-amber-950/20 dark:to-orange-950/20 border-amber-200 dark:border-amber-800/50">
                      <CardHeader>
                        <div className="flex items-center justify-between">
                          <CardTitle className="text-xl font-serif font-bold text-amber-800 dark:text-amber-200">
                            üåô ÂàÜ‰∫´ÂõæÁâáÂ∑≤ÁîüÊàê
                          </CardTitle>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={handleCloseShareImage}
                            className="text-amber-600 dark:text-amber-400 hover:bg-amber-100 dark:hover:bg-amber-900/30"
                          >
                            ‚úï
                          </Button>
                        </div>
                      </CardHeader>
                      <CardContent className="p-6">
                        <div className="text-center">
                          <p className="text-amber-700 dark:text-amber-300 font-serif mb-6">
                            ÊÇ®ÁöÑÊ¢¶Â¢ÉËß£ÊûêÂõæÁâáÂ∑≤ÊåâÁÖßÂÆã‰ª£ÁæéÂ≠¶È£éÊ†ºÁîüÊàêÔºåÈÄÇÂêàÂàÜ‰∫´Âà∞Â∞èÁ∫¢‰π¶Á≠âÁ§æ‰∫§Âπ≥Âè∞
                          </p>
                          
                          {/* ÂàÜ‰∫´ÂõæÁâáÈ¢ÑËßà */}
                          <div className="mb-6 flex justify-center">
                            <div className="relative">
                              <Image 
                                src={shareImageUrl} 
                                alt="Ê¢¶Â¢ÉËß£ÊûêÂàÜ‰∫´ÂõæÁâá" 
                                width={384}
                                height={384}
                                className="max-w-sm w-full h-auto rounded-lg shadow-lg border border-amber-200 dark:border-amber-700"
                              />
                              <div className="absolute -top-3 -right-3 bg-amber-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                                üåô
                              </div>
                            </div>
                          </div>
                          
                          {/* Êìç‰ΩúÊåâÈíÆ */}
                          <div className="flex flex-col sm:flex-row gap-4 justify-center items-center">
                            <Button
                              onClick={handleDownloadShareImage}
                              className="bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white font-serif px-6 py-2"
                            >
                              <Download className="h-4 w-4 mr-2" />
                              ‰∏ãËΩΩÂõæÁâá
                            </Button>
                            <p className="text-sm text-amber-600 dark:text-amber-400 font-serif">
                              Âª∫ËÆÆ‰øùÂ≠òÂà∞Áõ∏ÂÜåÂêéÂàÜ‰∫´Âà∞Á§æ‰∫§Âπ≥Âè∞
                            </p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  </div>
                )}
                
                {/* Â∫ïÈÉ®Ë£ÖÈ•∞ */}
                <div className="flex items-center justify-center mt-8 text-amber-600 dark:text-amber-400">
                  <div className="w-12 h-px bg-amber-400 dark:bg-amber-600"></div>
                  <div className="mx-4 text-sm font-serif">‚ú¶ Ê¢¶Â¢ÉËß£ÊûêÂÆåÊàê ‚ú¶</div>
                  <div className="w-12 h-px bg-amber-400 dark:bg-amber-600"></div>
                </div>
              </div>
            </section>
          )}
        </div>
      </main>

      {/* Footer - ÂÆã‰ª£ÁæéÂ≠¶È£éÊ†º */}
        <footer className="border-t-2 border-amber-300 dark:border-amber-600 bg-gradient-to-r from-amber-50 via-orange-50 to-red-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 backdrop-blur-sm mt-20 relative">
          <div className="container mx-auto px-4 py-12">
            <div className="text-center">
              {/* Ë£ÖÈ•∞ÊÄßÂõæÊ°à */}
              <div className="flex items-center justify-center mb-6">
                <div className="w-8 h-px bg-amber-400 dark:bg-amber-600"></div>
                <div className="mx-4 w-4 h-4 border-2 border-amber-400 dark:border-amber-600 rounded-full bg-amber-100 dark:bg-amber-800"></div>
                <div className="w-24 h-px bg-amber-400 dark:bg-amber-600"></div>
                <div className="mx-4 text-amber-600 dark:text-amber-400">
                  <svg className="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                </div>
                <div className="w-24 h-px bg-amber-400 dark:bg-amber-600"></div>
                <div className="mx-4 w-4 h-4 border-2 border-amber-400 dark:border-amber-600 rounded-full bg-amber-100 dark:bg-amber-800"></div>
                <div className="w-8 h-px bg-amber-400 dark:bg-amber-600"></div>
              </div>
              
              <div className="text-amber-700 dark:text-amber-300">
                <p className="text-lg font-serif mb-2">‰º†ÊâøÂçÉÂπ¥Êô∫ÊÖßÔºåËûçÊ±áÁé∞‰ª£ÁßëÊäÄ</p>
                <p className="text-sm font-serif opacity-80">&copy; 2024 Â§©Êú∫AI ¬∑ Ê¢¶Â¢ÉËß£Êûê‰∏ìÂÆ∂</p>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </div>
  )
}